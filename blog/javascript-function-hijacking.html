<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JavaScript 函数劫持 | 匠心博客</title>
    <meta name="description" content="小青年,匠心,小青年博客,匠心博客,前端开发,android,技术宅,菜鸟教程,一个神奇的博客。">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.c0a91c83.css" as="style"><link rel="preload" href="/assets/js/app.d8a5c125.js" as="script"><link rel="preload" href="/assets/js/27.57947f6a.js" as="script"><link rel="preload" href="/assets/js/16.91ab4518.js" as="script"><link rel="preload" href="/assets/js/31.d973ec6a.js" as="script"><link rel="prefetch" href="/assets/js/1.527e7f5f.js"><link rel="prefetch" href="/assets/js/10.f18deb89.js"><link rel="prefetch" href="/assets/js/11.ef2caa43.js"><link rel="prefetch" href="/assets/js/12.a1860c89.js"><link rel="prefetch" href="/assets/js/13.98d6eae2.js"><link rel="prefetch" href="/assets/js/14.74f75043.js"><link rel="prefetch" href="/assets/js/15.c78a2755.js"><link rel="prefetch" href="/assets/js/17.9d11a651.js"><link rel="prefetch" href="/assets/js/18.ec5a447d.js"><link rel="prefetch" href="/assets/js/19.6825ef5a.js"><link rel="prefetch" href="/assets/js/2.501ebeec.js"><link rel="prefetch" href="/assets/js/20.a2005136.js"><link rel="prefetch" href="/assets/js/21.08d11387.js"><link rel="prefetch" href="/assets/js/22.bc5625c1.js"><link rel="prefetch" href="/assets/js/23.fca36c69.js"><link rel="prefetch" href="/assets/js/24.91f44306.js"><link rel="prefetch" href="/assets/js/25.498dc953.js"><link rel="prefetch" href="/assets/js/26.687934c9.js"><link rel="prefetch" href="/assets/js/28.2ef6ff5c.js"><link rel="prefetch" href="/assets/js/29.5a197892.js"><link rel="prefetch" href="/assets/js/30.abe545b3.js"><link rel="prefetch" href="/assets/js/32.400d48c9.js"><link rel="prefetch" href="/assets/js/33.a8237a2f.js"><link rel="prefetch" href="/assets/js/34.e01312c1.js"><link rel="prefetch" href="/assets/js/35.72bb43ac.js"><link rel="prefetch" href="/assets/js/36.a6779dd5.js"><link rel="prefetch" href="/assets/js/37.dfc97422.js"><link rel="prefetch" href="/assets/js/38.3be6ea22.js"><link rel="prefetch" href="/assets/js/39.7f417ea2.js"><link rel="prefetch" href="/assets/js/4.e2068a2e.js"><link rel="prefetch" href="/assets/js/40.ceda4d68.js"><link rel="prefetch" href="/assets/js/41.0e8729e1.js"><link rel="prefetch" href="/assets/js/42.a06bb144.js"><link rel="prefetch" href="/assets/js/43.16d0136f.js"><link rel="prefetch" href="/assets/js/44.68165a86.js"><link rel="prefetch" href="/assets/js/45.a1562979.js"><link rel="prefetch" href="/assets/js/46.5e4b4f98.js"><link rel="prefetch" href="/assets/js/47.4dfc78b5.js"><link rel="prefetch" href="/assets/js/48.3ba5394c.js"><link rel="prefetch" href="/assets/js/49.f9d0ccf7.js"><link rel="prefetch" href="/assets/js/5.381cf335.js"><link rel="prefetch" href="/assets/js/50.3e5e3a04.js"><link rel="prefetch" href="/assets/js/51.43cc1312.js"><link rel="prefetch" href="/assets/js/52.5cce9f79.js"><link rel="prefetch" href="/assets/js/53.88567210.js"><link rel="prefetch" href="/assets/js/54.41c27261.js"><link rel="prefetch" href="/assets/js/55.b23a2b48.js"><link rel="prefetch" href="/assets/js/56.65b2dd2c.js"><link rel="prefetch" href="/assets/js/57.cd465a06.js"><link rel="prefetch" href="/assets/js/58.5a12b8d4.js"><link rel="prefetch" href="/assets/js/59.4f3b12ea.js"><link rel="prefetch" href="/assets/js/6.0b7ad9fb.js"><link rel="prefetch" href="/assets/js/60.804b4ba9.js"><link rel="prefetch" href="/assets/js/61.755bec4d.js"><link rel="prefetch" href="/assets/js/62.ad82181e.js"><link rel="prefetch" href="/assets/js/63.6d139087.js"><link rel="prefetch" href="/assets/js/64.b7c8a4ee.js"><link rel="prefetch" href="/assets/js/65.478bf4ca.js"><link rel="prefetch" href="/assets/js/66.0eae3172.js"><link rel="prefetch" href="/assets/js/67.d0110468.js"><link rel="prefetch" href="/assets/js/68.beb39f70.js"><link rel="prefetch" href="/assets/js/69.02bf177b.js"><link rel="prefetch" href="/assets/js/7.412b07c8.js"><link rel="prefetch" href="/assets/js/70.86058525.js"><link rel="prefetch" href="/assets/js/71.88964ba2.js"><link rel="prefetch" href="/assets/js/72.bffe8566.js"><link rel="prefetch" href="/assets/js/73.19daeedc.js"><link rel="prefetch" href="/assets/js/74.e871692d.js"><link rel="prefetch" href="/assets/js/75.e90167fb.js"><link rel="prefetch" href="/assets/js/76.3e1e8e91.js"><link rel="prefetch" href="/assets/js/77.60f4a720.js"><link rel="prefetch" href="/assets/js/78.19ac40f7.js"><link rel="prefetch" href="/assets/js/79.718c3852.js"><link rel="prefetch" href="/assets/js/8.d38b022c.js"><link rel="prefetch" href="/assets/js/80.8028e156.js"><link rel="prefetch" href="/assets/js/81.9b9a4c91.js"><link rel="prefetch" href="/assets/js/82.45fa7851.js"><link rel="prefetch" href="/assets/js/83.e2c99b6a.js"><link rel="prefetch" href="/assets/js/84.442d55b6.js"><link rel="prefetch" href="/assets/js/85.a4e78730.js"><link rel="prefetch" href="/assets/js/86.a05be69c.js"><link rel="prefetch" href="/assets/js/87.035a6273.js"><link rel="prefetch" href="/assets/js/88.17a2b0f2.js"><link rel="prefetch" href="/assets/js/89.8c295cd4.js"><link rel="prefetch" href="/assets/js/9.ec7e65f8.js"><link rel="prefetch" href="/assets/js/90.51ceb759.js"><link rel="prefetch" href="/assets/js/91.141dd9bf.js"><link rel="prefetch" href="/assets/js/92.732e361b.js"><link rel="prefetch" href="/assets/js/93.9be31e7e.js"><link rel="prefetch" href="/assets/js/94.e980967d.js"><link rel="prefetch" href="/assets/js/95.e107b887.js"><link rel="prefetch" href="/assets/js/96.e0d6f728.js"><link rel="prefetch" href="/assets/js/97.53ebd0aa.js"><link rel="prefetch" href="/assets/js/98.bf68fc26.js"><link rel="prefetch" href="/assets/js/99.22190bf3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c0a91c83.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">匠心博客</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/index.html" class="nav-link">博文</a></div><div class="nav-item"><a href="/note/index.html" class="nav-link">笔记</a></div><div class="nav-item"><a href="/nav/index.html" class="nav-link">导航</a></div><div class="nav-item"><a href="/about/index.html" class="nav-link">关于我</a></div> <a href="https://github.com/zhaomenghuan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/index.html" class="nav-link">博文</a></div><div class="nav-item"><a href="/note/index.html" class="nav-link">笔记</a></div><div class="nav-item"><a href="/nav/index.html" class="nav-link">导航</a></div><div class="nav-item"><a href="/about/index.html" class="nav-link">关于我</a></div> <a href="https://github.com/zhaomenghuan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>JavaScript 函数劫持</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/javascript-function-hijacking.html#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/javascript-function-hijacking.html#什么是函数劫持？" class="sidebar-link">什么是函数劫持？</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/javascript-function-hijacking.html#call、apply、bind" class="sidebar-link">call、apply、bind</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/javascript-function-hijacking.html#call、apply、bind-的区别" class="sidebar-link">call、apply、bind 的区别</a></li><li class="sidebar-sub-header"><a href="/blog/javascript-function-hijacking.html#手写一个-bind-方法" class="sidebar-link">手写一个 bind 方法</a></li><li class="sidebar-sub-header"><a href="/blog/javascript-function-hijacking.html#实例：框架内函数包装器" class="sidebar-link">实例：框架内函数包装器</a></li></ul></li><li><a href="/blog/javascript-function-hijacking.html#proxy、reflect" class="sidebar-link">Proxy、Reflect</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/javascript-function-hijacking.html#proxy-代理器" class="sidebar-link">Proxy(代理器)</a></li><li class="sidebar-sub-header"><a href="/blog/javascript-function-hijacking.html#reflect-反射机制" class="sidebar-link">Reflect(反射机制)</a></li><li class="sidebar-sub-header"><a href="/blog/javascript-function-hijacking.html#实例：发布-订阅模式实现" class="sidebar-link">实例：发布-订阅模式实现</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="javascript-函数劫持">JavaScript 函数劫持</h1> <h2 id="前言">前言</h2> <p>最近研究微信小程序源码发现一件很有意思的事情，很多函数都被 <code>surroundByTryCatchFactory</code> 的方法包装了一下，函数调用错误的堆栈信息都会被统一格式化打印出来，这个在 JS SDK 的设计中很好用，偶然发现这种机制叫做 JavaScript 劫持，决定研究一下背后的技术原理。</p> <h2 id="什么是函数劫持？">什么是函数劫持？</h2> <p>函数劫持，顾名思义，即在一个函数运行之前把它劫持下来，添加我们想要的功能。当这个函数实际运行的时候，它已经不是原本的函数了，而是带上了被我们添加上去的功能，这也是我们常见的 <code>钩子函数</code> 的原理之一。</p> <p>一般的劫持原理都是一个思路：</p> <ul><li>1.使用新的变量保存即将被劫持的函数。</li> <li>2.改写被劫持函数的功能。</li> <li>3.在被劫持函数的末尾段（或者其他适当部位）重新调用重写之前的函数。</li></ul> <p>例如很多时候我们需要重新修改 console 对象进行日志收集或者格式化，如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> StackTrace <span class="token keyword">from</span> <span class="token string">&quot;stacktrace-js&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> consoleProxy <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> methodList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;log&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;info&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;warn&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;debug&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
methodList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">method</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 备份 console 对象</span>
  consoleProxy<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> window<span class="token punctuation">.</span>console<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 重写 console 代理</span>
  window<span class="token punctuation">.</span>console<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token parameter">message</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> StackFrame <span class="token operator">=</span> StackTrace<span class="token punctuation">.</span><span class="token function">getSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 格式化 console 信息</span>
    <span class="token keyword">let</span> proxyMessage <span class="token operator">=</span> <span class="token punctuation">{</span>
      level<span class="token punctuation">:</span> method<span class="token punctuation">,</span>
      message<span class="token punctuation">:</span> message<span class="token punctuation">,</span>
      location<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>StackFrame<span class="token punctuation">.</span>fileName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>StackFrame<span class="token punctuation">.</span>lineNumber<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
        StackFrame<span class="token punctuation">.</span>columnNumber
      <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    consoleProxy<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> proxyMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这里通过改写 <code>window.console</code> 对象方法实现劫持功能，但是这里我们对原有对象进行了污染，某些情况下会有不正常的预期。</p> <p>那么这里我们怎么判断我们的对象是否被劫持了呢？以 <code>console.log</code> 为例，正常情况下：</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 结果：</span>
<span class="token punctuation">(</span><span class="token string">&quot;function log() { [native code] }&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>我们上面的例子会变成：</p> <div class="language-js extra-class"><pre class="language-js"><code>&quot;<span class="token parameter">message</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> StackFrame <span class="token operator">=</span> StackTrace<span class="token punctuation">.</span><span class="token function">getSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 格式化 console 信息</span>
  <span class="token keyword">let</span> proxyMessage <span class="token operator">=</span> <span class="token punctuation">{</span>
    level<span class="token punctuation">:</span> method<span class="token punctuation">,</span>
    message<span class="token punctuation">:</span> message<span class="token punctuation">,</span>
    location<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>StackFrame<span class="token punctuation">.</span>fileName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>StackFrame<span class="token punctuation">.</span>lineNumber<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
      StackFrame<span class="token punctuation">.</span>columnNumber
    <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  consoleProxy<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> proxyMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>&quot;
</code></pre></div><p>上述我们对于对象属性的劫持也可以使用 <code>Object.defineProperty</code> 的 <code>setter</code> 和 <code>getter</code> 实现。</p> <h2 id="call、apply、bind">call、apply、bind</h2> <h3 id="call、apply、bind-的区别">call、apply、bind 的区别</h3> <p><code>call()</code>、<code>apply()</code> 方法是使用一个指定的 this 值和单独给出的一个或多个参数来调用一个函数，而 <code>bind()</code> 方法创建一个新的函数，在调用时设置 this 关键字为提供的值，并在调用新函数时，将给定参数列表作为原函数的参数序列的前若干项。</p> <blockquote><p>function.call(thisArg, arg1, arg2, ...)</p></blockquote> <p>参数：</p> <ul><li>thisArg：在 function 函数运行时使用的 this 值。如果这个函数处于非严格模式下，则指定为 null 或 undefined 时会自动替换为指向全局对象，原始值会被包装。</li> <li>arg1, arg2, ...：指定的参数列表。</li></ul> <blockquote><p>function.apply(thisArg, [argsArray])</p></blockquote> <p>参数：</p> <ul><li>thisArg：在 function 函数运行时使用的 this 值。如果这个函数处于非严格模式下，则指定为 null 或 undefined 时会自动替换为指向全局对象，原始值会被包装。</li> <li>argsArray：可选的。一个数组或者类数组对象，其中的数组元素将作为单独的参数传给 func 函数。如果该参数的值为 null 或 undefined，则表示不需要传入任何参数。从 ECMAScript 5 开始可以使用类数组对象。</li></ul> <blockquote><p>function.bind(thisArg[, arg1[, arg2[, ...]]])</p></blockquote> <p>参数：</p> <ul><li>thisArg：调用绑定函数时作为 this 参数传递给目标函数的值。 如果使用 new 运算符构造绑定函数，则忽略该值。当使用 bind 在 setTimeout 中创建一个函数（作为回调提供）时，作为 thisArg 传递的任何原始值都将转换为 object。如果 bind 函数的参数列表为空，执行作用域的 this 将被视为新函数的 thisArg。</li> <li>arg1, arg2, ...：当目标函数被调用时，预先添加到绑定函数的参数列表中的参数。</li></ul> <h3 id="手写一个-bind-方法">手写一个 bind 方法</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>bind<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">bind</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">thisArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
      args <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>thisArgs<span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="实例：框架内函数包装器">实例：框架内函数包装器</h3> <p>我们先看一段代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token function-variable function">fun</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>很显然这样一段代码在 <code>&quot;use strict&quot;</code> 模式下执行存在 <code>a is not defined</code> 的错误。那么我们能否统一 <code>try-catch</code> 到这种情况下的异常然后记录下来呢？</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 框架内函数包装器 try-catch
 * @param {Function} fn     需要执行的函数
 * @param {string}   errMsg 错误信息
 * @return {Function}       包装函数
 */</span>
<span class="token keyword">function</span> <span class="token function">surroundByTryCatchFactory</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> errMsg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      errMsg <span class="token operator">=</span> error<span class="token punctuation">.</span>message <span class="token operator">+</span> <span class="token string">&quot;;\n&quot;</span> <span class="token operator">+</span> errMsg<span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`FrameworkScriptError\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>errMsg<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token punctuation">.</span>stack<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>测试：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token function-variable function">fun</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

fun <span class="token operator">=</span> <span class="token function">surroundByTryCatchFactory</span><span class="token punctuation">(</span>fun<span class="token punctuation">,</span> <span class="token string">&quot;参数不对&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="/assets/img/surroundByTryCatchFactory.4bcf30e4.png" alt></p> <h2 id="proxy、reflect">Proxy、Reflect</h2> <h3 id="proxy-代理器">Proxy(代理器)</h3> <blockquote><p>let proxy = new Proxy(target, handler);</p></blockquote> <p>参数:</p> <ul><li>target：用 Proxy 包装的目标对象（可以是任何类型的对象，包括原生数组，函数，甚至另一个代理）。</li> <li>handler：一个代理对象，其属性是当执行一个操作时定义代理的行为的函数。</li></ul> <p>一共有 13 种可代理操作，每种操作的代号（属性名/方法名）和触发这种操作的方式列举如下。注意，如果没有定义某种操作，那么这种操作会被转发到目标对象身上。</p> <ul><li>handler.getPrototypeOf()：在读取代理对象的原型时触发该操作，比如在执行 <code>Object.getPrototypeOf(proxy)</code> 时。</li> <li>handler.setPrototypeOf()：在设置代理对象的原型时触发该操作，比如在执行 <code>Object.setPrototypeOf(proxy, null)</code> 时。</li> <li>handler.isExtensible()：在判断一个代理对象是否是可扩展时触发该操作，比如在执行 <code>Object.isExtensible(proxy)</code> 时。</li> <li>handler.preventExtensions()：在让一个代理对象不可扩展时触发该操作，比如在执行 <code>Object.preventExtensions(proxy)</code> 时。</li> <li>handler.getOwnPropertyDescriptor()：在获取代理对象某个属性的属性描述时触发该操作，比如在执行 <code>Object.getOwnPropertyDescriptor(proxy, &quot;foo&quot;)</code> 时。</li> <li>handler.defineProperty()：在定义代理对象某个属性时的属性描述时触发该操作，比如在执行 <code>Object.defineProperty(proxy, &quot;foo&quot;, {})</code>时。</li> <li>handler.has()：在判断代理对象是否拥有某个属性时触发该操作，比如在执行 <code>&quot;foo&quot; in proxy</code> 时。</li> <li>handler.get()：在读取代理对象的某个属性时触发该操作，比如在执行 <code>proxy.foo</code> 时。</li> <li>handler.set()：在给代理对象的某个属性赋值时触发该操作，比如在执行 <code>proxy.foo = 1</code> 时。</li> <li>handler.deleteProperty()：在删除代理对象的某个属性时触发该操作，比如在执行 <code>delete proxy.foo</code> 时。</li> <li>handler.ownKeys()：在获取代理对象的所有属性键时触发该操作，比如在执行 <code>Object.getOwnPropertyNames(proxy)</code> 时。</li> <li>handler.apply()：当目标对象为函数，且被调用时触发。</li> <li>handler.construct()：在给一个目标对象为构造函数的代理对象构造实例时触发该操作，比如在执行 <code>new proxy()</code> 时。</li></ul> <h3 id="reflect-反射机制">Reflect(反射机制)</h3> <p>Reflect 是一个内置的对象，它提供拦截 JavaScript 操作的方法。Reflect 不是一个函数对象，因此它是不可构造的。这些方法与处理器对象 handler 的方法相同。Reflect 对象一共有 13 个静态方法。</p> <ul><li>Reflect.apply(target, thisArg, args)</li> <li>Reflect.construct(target, args)</li> <li>Reflect.get(target, name, receiver)</li> <li>Reflect.set(target, name, value, receiver)</li> <li>Reflect.defineProperty(target, name, desc)</li> <li>Reflect.deleteProperty(target, name)</li> <li>Reflect.has(target, name)</li> <li>Reflect.ownKeys(target)</li> <li>Reflect.isExtensible(target)</li> <li>Reflect.preventExtensions(target)</li> <li>Reflect.getOwnPropertyDescriptor(target, name)</li> <li>Reflect.getPrototypeOf(target)</li> <li>Reflect.setPrototypeOf(target, prototype)</li></ul> <p>Reflect 对象的设计目的有这样几个：</p> <ul><li>将 Object 对象的一些明显属于语言内部的方法（比如 <code>Object.defineProperty</code>），放到 Reflect 对象上。</li> <li>修改某些 Object 方法的返回结果，让其变得更合理。比如 <code>Object.defineProperty(obj, name, desc)</code> 在无法定义属性时，会抛出一个错误，而 <code>Reflect.defineProperty(obj, name, desc)</code> 则会返回 false。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 老写法</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// success</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// failure</span>
<span class="token punctuation">}</span>

<span class="token comment">// 新写法</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>Reflect<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> attributes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// success</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// failure</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>让 Object 操作都变成函数行为。某些 Object 操作是命令式，比如 <code>name in obj</code> 和 <code>delete obj[name]</code>，而 <code>Reflect.has(obj, name)</code> 和 <code>Reflect.deleteProperty(obj, name)</code> 让它们变成了函数行为。</p></li> <li><p>Reflect 对象的方法与 Proxy 对象的方法一一对应，只要是 Proxy 对象的方法，就能在 Reflect 对象上找到对应的方法。这就让 Proxy 对象可以方便地调用对应的 Reflect 方法，完成默认行为，作为修改行为的基础。也就是说，不管 Proxy 怎么修改默认行为，你总可以在 Reflect 上获取默认行为。</p></li></ul> <p>Vue.js 1.x-2.x 版本数据双向绑定机制中数据变动监听是基于 <code>Object.defineProperty</code> 的 Getter/Setter 机制实现，3.0 中基于 Proxy 进行了改造，下面是数据变动监听核心实现的最简例子：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * 创建数据观察者实例
   * @param {Object} data
   */</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data <span class="token operator">||</span> <span class="token keyword">typeof</span> data <span class="token operator">!==</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">proxy</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 代理方法
   * @param {*} data
   */</span>
  <span class="token function">proxy</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">get</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`data.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 被读取`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">set</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`data.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 被赋值`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>测试：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token string">&quot;zhaomenghuan&quot;</span><span class="token punctuation">,</span>
  website<span class="token punctuation">:</span> <span class="token string">&quot;https://zhaomenghuan.js.org&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> proxyData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxyData<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="实例：发布-订阅模式实现">实例：发布-订阅模式实现</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">EventEmitter</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>events <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nextGuid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">on</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> listener</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> events <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>events<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      events<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> guid <span class="token operator">=</span> <span class="token string">&quot;uuid_&quot;</span> <span class="token operator">+</span> <span class="token operator">++</span><span class="token keyword">this</span><span class="token punctuation">.</span>nextGuid<span class="token punctuation">;</span>
    events<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">[</span>guid<span class="token punctuation">]</span> <span class="token operator">=</span> listener<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">once</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> listener</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">Reflect</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>listener<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">off</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> listener</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> events <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>events<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> handlers <span class="token operator">=</span> events<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>handlers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>handlers<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> listener <span class="token operator">===</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Reflect<span class="token punctuation">.</span><span class="token function">deleteProperty</span><span class="token punctuation">(</span>handlers<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">emit</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> events <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">;</span>
    <span class="token keyword">const</span> handlers <span class="token operator">=</span> events<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> listener <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>handlers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">Reflect</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>listener<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div data-v-58ccb297><p class="descript" data-v-58ccb297>写文章不容易，也许写这些代码就几分钟的事，写一篇大家好接受的文章或许需要几天的酝酿，然后加上几天的码字，累并快乐着。如果文章对您有帮助请我喝杯咖啡吧！</p> <img src="/supportme.png" class="pay-code" data-v-58ccb297> <div data-v-58ccb297><div id="container"></div></div> <div class="footer" data-v-5562bdd2 data-v-58ccb297><p data-v-5562bdd2>站点总访问量： 站点总访客数：</p> <p data-v-5562bdd2>博客内容遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" data-v-5562bdd2>知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></p> <p data-v-5562bdd2>赵梦欢 © 2015 - 2019</p></div></div></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.d8a5c125.js" defer></script><script src="/assets/js/27.57947f6a.js" defer></script><script src="/assets/js/16.91ab4518.js" defer></script><script src="/assets/js/31.d973ec6a.js" defer></script>
  </body>
</html>
