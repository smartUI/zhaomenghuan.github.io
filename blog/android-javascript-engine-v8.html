<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Android JavaScript 引擎学习之初探 V8 | 匠心博客</title>
    <meta name="description" content="小青年,匠心,小青年博客,匠心博客,前端开发,android,技术宅,菜鸟教程,一个神奇的博客。">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.c0a91c83.css" as="style"><link rel="preload" href="/assets/js/app.d8a5c125.js" as="script"><link rel="preload" href="/assets/js/49.f9d0ccf7.js" as="script"><link rel="preload" href="/assets/js/16.91ab4518.js" as="script"><link rel="preload" href="/assets/js/31.d973ec6a.js" as="script"><link rel="prefetch" href="/assets/js/1.527e7f5f.js"><link rel="prefetch" href="/assets/js/10.f18deb89.js"><link rel="prefetch" href="/assets/js/11.ef2caa43.js"><link rel="prefetch" href="/assets/js/12.a1860c89.js"><link rel="prefetch" href="/assets/js/13.98d6eae2.js"><link rel="prefetch" href="/assets/js/14.74f75043.js"><link rel="prefetch" href="/assets/js/15.c78a2755.js"><link rel="prefetch" href="/assets/js/17.9d11a651.js"><link rel="prefetch" href="/assets/js/18.ec5a447d.js"><link rel="prefetch" href="/assets/js/19.6825ef5a.js"><link rel="prefetch" href="/assets/js/2.501ebeec.js"><link rel="prefetch" href="/assets/js/20.a2005136.js"><link rel="prefetch" href="/assets/js/21.08d11387.js"><link rel="prefetch" href="/assets/js/22.bc5625c1.js"><link rel="prefetch" href="/assets/js/23.fca36c69.js"><link rel="prefetch" href="/assets/js/24.91f44306.js"><link rel="prefetch" href="/assets/js/25.498dc953.js"><link rel="prefetch" href="/assets/js/26.687934c9.js"><link rel="prefetch" href="/assets/js/27.57947f6a.js"><link rel="prefetch" href="/assets/js/28.2ef6ff5c.js"><link rel="prefetch" href="/assets/js/29.5a197892.js"><link rel="prefetch" href="/assets/js/30.abe545b3.js"><link rel="prefetch" href="/assets/js/32.400d48c9.js"><link rel="prefetch" href="/assets/js/33.a8237a2f.js"><link rel="prefetch" href="/assets/js/34.e01312c1.js"><link rel="prefetch" href="/assets/js/35.72bb43ac.js"><link rel="prefetch" href="/assets/js/36.a6779dd5.js"><link rel="prefetch" href="/assets/js/37.dfc97422.js"><link rel="prefetch" href="/assets/js/38.3be6ea22.js"><link rel="prefetch" href="/assets/js/39.7f417ea2.js"><link rel="prefetch" href="/assets/js/4.e2068a2e.js"><link rel="prefetch" href="/assets/js/40.ceda4d68.js"><link rel="prefetch" href="/assets/js/41.0e8729e1.js"><link rel="prefetch" href="/assets/js/42.a06bb144.js"><link rel="prefetch" href="/assets/js/43.16d0136f.js"><link rel="prefetch" href="/assets/js/44.68165a86.js"><link rel="prefetch" href="/assets/js/45.a1562979.js"><link rel="prefetch" href="/assets/js/46.5e4b4f98.js"><link rel="prefetch" href="/assets/js/47.4dfc78b5.js"><link rel="prefetch" href="/assets/js/48.3ba5394c.js"><link rel="prefetch" href="/assets/js/5.381cf335.js"><link rel="prefetch" href="/assets/js/50.3e5e3a04.js"><link rel="prefetch" href="/assets/js/51.43cc1312.js"><link rel="prefetch" href="/assets/js/52.5cce9f79.js"><link rel="prefetch" href="/assets/js/53.88567210.js"><link rel="prefetch" href="/assets/js/54.41c27261.js"><link rel="prefetch" href="/assets/js/55.b23a2b48.js"><link rel="prefetch" href="/assets/js/56.65b2dd2c.js"><link rel="prefetch" href="/assets/js/57.cd465a06.js"><link rel="prefetch" href="/assets/js/58.5a12b8d4.js"><link rel="prefetch" href="/assets/js/59.4f3b12ea.js"><link rel="prefetch" href="/assets/js/6.0b7ad9fb.js"><link rel="prefetch" href="/assets/js/60.804b4ba9.js"><link rel="prefetch" href="/assets/js/61.755bec4d.js"><link rel="prefetch" href="/assets/js/62.ad82181e.js"><link rel="prefetch" href="/assets/js/63.6d139087.js"><link rel="prefetch" href="/assets/js/64.b7c8a4ee.js"><link rel="prefetch" href="/assets/js/65.478bf4ca.js"><link rel="prefetch" href="/assets/js/66.0eae3172.js"><link rel="prefetch" href="/assets/js/67.d0110468.js"><link rel="prefetch" href="/assets/js/68.beb39f70.js"><link rel="prefetch" href="/assets/js/69.02bf177b.js"><link rel="prefetch" href="/assets/js/7.412b07c8.js"><link rel="prefetch" href="/assets/js/70.86058525.js"><link rel="prefetch" href="/assets/js/71.88964ba2.js"><link rel="prefetch" href="/assets/js/72.bffe8566.js"><link rel="prefetch" href="/assets/js/73.19daeedc.js"><link rel="prefetch" href="/assets/js/74.e871692d.js"><link rel="prefetch" href="/assets/js/75.e90167fb.js"><link rel="prefetch" href="/assets/js/76.3e1e8e91.js"><link rel="prefetch" href="/assets/js/77.60f4a720.js"><link rel="prefetch" href="/assets/js/78.19ac40f7.js"><link rel="prefetch" href="/assets/js/79.718c3852.js"><link rel="prefetch" href="/assets/js/8.d38b022c.js"><link rel="prefetch" href="/assets/js/80.8028e156.js"><link rel="prefetch" href="/assets/js/81.9b9a4c91.js"><link rel="prefetch" href="/assets/js/82.45fa7851.js"><link rel="prefetch" href="/assets/js/83.e2c99b6a.js"><link rel="prefetch" href="/assets/js/84.442d55b6.js"><link rel="prefetch" href="/assets/js/85.a4e78730.js"><link rel="prefetch" href="/assets/js/86.a05be69c.js"><link rel="prefetch" href="/assets/js/87.035a6273.js"><link rel="prefetch" href="/assets/js/88.17a2b0f2.js"><link rel="prefetch" href="/assets/js/89.8c295cd4.js"><link rel="prefetch" href="/assets/js/9.ec7e65f8.js"><link rel="prefetch" href="/assets/js/90.51ceb759.js"><link rel="prefetch" href="/assets/js/91.141dd9bf.js"><link rel="prefetch" href="/assets/js/92.732e361b.js"><link rel="prefetch" href="/assets/js/93.9be31e7e.js"><link rel="prefetch" href="/assets/js/94.e980967d.js"><link rel="prefetch" href="/assets/js/95.e107b887.js"><link rel="prefetch" href="/assets/js/96.e0d6f728.js"><link rel="prefetch" href="/assets/js/97.53ebd0aa.js"><link rel="prefetch" href="/assets/js/98.bf68fc26.js"><link rel="prefetch" href="/assets/js/99.22190bf3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c0a91c83.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">匠心博客</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/index.html" class="nav-link">博文</a></div><div class="nav-item"><a href="/note/index.html" class="nav-link">笔记</a></div><div class="nav-item"><a href="/nav/index.html" class="nav-link">导航</a></div><div class="nav-item"><a href="/about/index.html" class="nav-link">关于我</a></div> <a href="https://github.com/zhaomenghuan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/index.html" class="nav-link">博文</a></div><div class="nav-item"><a href="/note/index.html" class="nav-link">笔记</a></div><div class="nav-item"><a href="/nav/index.html" class="nav-link">导航</a></div><div class="nav-item"><a href="/about/index.html" class="nav-link">关于我</a></div> <a href="https://github.com/zhaomenghuan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>Android JavaScript 引擎学习之初探 V8</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/android-javascript-engine-v8.html#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/android-javascript-engine-v8.html#javascript-引擎" class="sidebar-link">JavaScript 引擎</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/android-javascript-engine-v8.html#j2v8-框架初探" class="sidebar-link">J2V8 框架初探</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/android-javascript-engine-v8.html#react-native-初探" class="sidebar-link">React Native 初探</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/android-javascript-engine-v8.html#参考" class="sidebar-link">参考</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="android-javascript-引擎学习之初探-v8">Android JavaScript 引擎学习之初探 V8</h1> <h2 id="前言">前言</h2> <p>之前一直都只是听说 V8 执行效率高，了解 Node 是运行在 V8 引擎上的，weex 在 Android 上也是使用 V8 引擎来执行 JS 的，但是对于 V8 的认识还是比较肤浅的层次。开始学习一下 V8 相关的内容，学习过程记录一下，利人利己。本系列文章可能更关注 V8 在 Android 上的应用，以及那些使用 V8 的框架到底做了一些什么工作。</p> <h2 id="javascript-引擎">JavaScript 引擎</h2> <p>目前在 Android／iOS 上运行 JavaScript，主要有两种方法：一种方法是利用系统的浏览器组件 WebView（Android）和
UIWebView／WKWebView（iOS）；另一种方法是编译和集成一个功能全面的 JavaScript 引擎。</p> <p>在 App 开发中经常会使用 WebView 加载一个网页，甚至构建一个完整应用，目前相关的框架和工具也比较多，例如使用 Cordova 构建多平台应用。当我们对于性能和体验要求比较高的时候，WebView 中解析 JS 的效率低（取决于 JavaScript 引擎）、DOM 渲染慢（取决于渲染引擎）以及系统碎片化严重对于 API 支持也不尽相同（取决于浏览器内核）往往影响性能瓶颈和开发体验。</p> <p>目前基于高性能 JavaScript 引擎的方案也有很多，如 React Native、weex、NativeScript、Tabrisjs 等，每个方案之间都有一些不一样的地方，不过都离不开底层 JavaScript 引擎的支持。要想了解这些上层框架的原理，我们首先需要了解 JavaScript 引擎的基本内容。</p> <p>JavaScript 引擎是一个专门处理 JavaScript 脚本的虚拟机，一般会附带在网页浏览器之中。在 Android 和 iOS 中可以运行的最主要的 JavaScript 引擎有 JavaScriptCore、V8、SpiderMonkey、Rhino，下面的表格列出他们在 iOS 和 Android 的兼容性。</p> <table><thead><tr><th style="text-align:center">JavaScript Engine</th> <th style="text-align:center">Android</th> <th style="text-align:center">iOS</th> <th style="text-align:center">维护</th></tr></thead> <tbody><tr><td style="text-align:center">JavaScriptCore</td> <td style="text-align:center">Interpreter and JIT</td> <td style="text-align:center">Interpreter only</td> <td style="text-align:center">Apple</td></tr> <tr><td style="text-align:center">V8</td> <td style="text-align:center">JIT</td> <td style="text-align:center">JIT only for jailbroken devices</td> <td style="text-align:center">Google</td></tr> <tr><td style="text-align:center">SpiderMonkey</td> <td style="text-align:center">Interpreter and JIT</td> <td style="text-align:center">Interpreter only</td> <td style="text-align:center">Mozilla</td></tr> <tr><td style="text-align:center">Rhino</td> <td style="text-align:center">Interpreter</td> <td style="text-align:center">Unsupported</td> <td style="text-align:center">Mozilla</td></tr></tbody></table> <p>JavaScriptCore 是一个在 WebKit 中提供 JS 引擎的开源框架，目前该引擎由 Apple 维护，使用于 Safari 浏览器，iOS7 后也集成到了 iPhone 平台。由于其使用 C 语言编写，因此在 Android 开发中并不能直接使用。Github 上的开源项目 <a href="https://github.com/ericwlange/AndroidJSCore" target="_blank" rel="noopener noreferrer">AndroidJSCore<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>(目前已经停止维护了，官方仓库指向<a href="https://github.com/LiquidPlayer/LiquidCore" target="_blank" rel="noopener noreferrer">LiquidCore<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>) 能够帮助开发者经过调用 Java 接口而使用 JavaScriptCore。</p> <p>V8 是由 Google 开发并维护的高性能开源 JS 引擎，采用 C++编写，使用于 Google Chrome 浏览器。同 JavaScriptCore 一样，在 Android 开发中，相关接口需要通过一层包装进行调用。Github 上的开源项目 <a href="https://github.com/eclipsesource/J2V8" target="_blank" rel="noopener noreferrer">J2V8<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 基于 jni 实现了 Java 对 V8 的封装，下文我们重点介绍一下。</p> <p>SpiderMonkey 最初由 Netscape 开发，如今由 Mozilla 开发并维护，且被广泛用于 Mozilla 产品（如 FireFox）。SpiderMonkey 提供了一些核心的 JavaScript 数据类型，如数字，字符串，数组，对象等等，以及一些方法如 Array.push。它还使得每个应用程序都容易将其自己的对象和方法暴露给 JavaScript 代码。应用开发者可以决定应用如何将与所写脚本相关的对象暴露出来。</p> <p>Rhino 是由 Mozilla 开发的开源 JS 引擎，采用 Java 编写，因此可以直接调用，在 JDK 6、JDK 7 中更是捆绑了该引擎，其提供的特性包括：</p> <ul><li>JavaScript 1.7 的全部特性</li> <li>可以用脚本方式调用 Java</li> <li>用一个 JavaScript Shell 来执行 JavaScript 脚本</li> <li>用一个 JavaScript 编译器来将 JavaScript 脚本文件转换成 Java 类文件</li> <li>用一个 JavaScript 调试器来调试 Rhino 执行的脚本</li></ul> <p>Nashorn 由 Oracle 开发并维护，从 JDK 8 开始，Rhino 被 Nashorn 代替，成为 JDK 默认 JS 引擎。Nashorn 同 JDK8 一同发布和开源，较 Rhino 而言性能更好，但不支持 Android Dalvik 虚拟机。</p> <p>结合<a href="https://neyoufan.github.io/2016/12/23/android/Android%20Js%E5%BC%95%E6%93%8E/%E5%9C%A8Android%E4%B8%8A%E4%BD%BF%E7%94%A8JS%E5%BC%95%E6%93%8E%E6%98%AF%E4%B8%80%E7%A7%8D%E4%BB%80%E4%B9%88%E6%A0%B7%E7%9A%84%E4%BD%93%E9%AA%8C%EF%BC%9F/" target="_blank" rel="noopener noreferrer">在 Android 上使用 JS 引擎是一种什么样的体验？<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>一文中的实验，可以得出结论：单从 JS 引擎来说，Rhino 执行不需要通过 JNI 且占用更少的内存，但执行效率很低；V8 和 JavaScriptCore 等 C 语言开发的引擎远胜于 Rhino 等 Java 开发的引擎，但需要一层 Java 包装层，并存在 JNI 调用性能问题。就 J2V8 和 AndroidJSCore 两个包装层而言：J2V8 的可用性、可靠性、健壮性更优；AndroidJSCore 还存在着不少的性能问题，在上述实验中出现较少，但实际开发中还存在很多坑。以上三种实现方案中更推荐 J2V8 方案。对于内存问题，J2V8 的内存释放机制较为完善，在实际开发中可以通过主动 release 来释放内存；对于 JNI 调用性能问题，J2V8 团队也在尝试通过批处理回调来进行优化，在将来的版本中会得到改善。</p> <h2 id="j2v8-框架初探">J2V8 框架初探</h2> <p>J2V8 是一套针对 V8 的 Java 绑定。J2V8 的开发为 Android 平台带来了高效的 Javascript 的执行环境，其以性能与内存消耗为设计目标。它采用了“基本类型优先”原则，意味着一个执行结果是基本类型，那么所返回的值也就是该基本类型。它还采用了“懒加载”技术，只有当 JS 执行结果被访问时，才会通过 JNI 复制到 Java 中。此外 J2V8 提供了 release()方法，开发者在某一对象不再需要时主动调用该方法去释放本地对象句柄，释放规则如下：</p> <ul><li>如果是由代码创建的对象，那么必须释放它；如果一个对象是通过返回语句传回来的话，系统会替你释放它；</li> <li>如果是由系统创建的对象，则无需担心释放，而如果对象是 JS 方法的返回值，就必须手动的释放它。</li> <li>官网地址：https://eclipsesource.com/blogs/tutorials/getting-started-with-j2v8/</li> <li>github 地址：https://github.com/eclipsesource/J2V8</li> <li>maven 仓库地址：http://central.maven.org/maven2/com/eclipsesource/j2v8</li></ul> <p>在 Android 中使用 J2V8 也很简单，我们从 maven 仓库上下载.arr 文件，然后放在工程目录下的 lib 文件夹中，修改 app 下 build.gradle 文件，添加如下内容：</p> <div class="language-groovy extra-class"><pre class="language-groovy"><code>repositories <span class="token punctuation">{</span>
    flatDir <span class="token punctuation">{</span>
        dirs <span class="token string">'libs'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

dependencies <span class="token punctuation">{</span>
    <span class="token punctuation">...</span>
    <span class="token function">compile</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">'j2v8-4.8.0'</span><span class="token punctuation">,</span> ext<span class="token punctuation">:</span><span class="token string">'aar'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后就可以在我们的 Java 代码中通过 API 运行 Js 代码了，同样可以用 Js 调用 Java 中注册的方法。</p> <p>先写一个 Hello World 测试一下我们的 j2v8 集成是否正常。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 创建JS上下文</span>
<span class="token class-name">V8</span> runtime <span class="token operator">=</span> V8<span class="token punctuation">.</span><span class="token function">createV8Runtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 执行js代码</span>
<span class="token keyword">int</span> result <span class="token operator">=</span> runtime<span class="token punctuation">.</span><span class="token function">executeIntegerScript</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span>
        <span class="token operator">+</span> <span class="token string">&quot;var hello = 'hello, ';\n&quot;</span>
        <span class="token operator">+</span> <span class="token string">&quot;var world = 'world!';\n&quot;</span>
        <span class="token operator">+</span> <span class="token string">&quot;hello.concat(world).length;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 打印返回值</span>
<span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 释放对象</span>
runtime<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>接着我们定义一个自定义方法注册到 JS 上下文。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 创建Java方法，并注册到JS上下文</span>
<span class="token class-name">JavaVoidCallback</span> callback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavaVoidCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">V8Object</span> receiver<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">V8Array</span> parameters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Toast</span><span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parameters<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Toast</span><span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
runtime<span class="token punctuation">.</span><span class="token function">registerJavaMethod</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token string">&quot;showToast&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>自定义方法需要在使用前进行注册，然后我们可以通过<code>executeVoidScript</code>执行代码</p> <div class="language-java extra-class"><pre class="language-java"><code>runtime<span class="token punctuation">.</span><span class="token function">executeVoidScript</span><span class="token punctuation">(</span><span class="token string">&quot;showToast('&quot;</span><span class="token operator">+</span>result<span class="token operator">+</span><span class="token string">&quot;')&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这些代码都是写在 Java 中，在实际应用中我们一般都会将 js 写<code>.js</code>文件中。这里我们定义一个工具类：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>content</span><span class="token punctuation">.</span><span class="token class-name">Context</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io</span><span class="token punctuation">.</span><span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io</span><span class="token punctuation">.</span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io</span><span class="token punctuation">.</span><span class="token class-name">InputStream</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileUtil</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getFromAssets</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">String</span> fileName<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">InputStream</span> input <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            input <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ByteArrayOutputStream</span> output <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                output<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            output<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            input<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> output<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后我们就可以这样执行 js:</p> <div class="language-js extra-class"><pre class="language-js"><code>String script <span class="token operator">=</span> FileUtil<span class="token punctuation">.</span><span class="token function">getFromAssets</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">&quot;www/index.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
runtime<span class="token punctuation">.</span><span class="token function">executeScript</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="react-native-初探">React Native 初探</h2> <p>RN 会把应用的 JS 代码（包括依赖的 framework）编译成一个 js 文件（一般命名为 index.android.bundle), , RN 的整体框架目标就是为了解释运行这个 js 脚本文件，如果是 js 扩展的 API， 则直接通过 bridge 调用 native 方法; 如果是 UI 界面， 则映射到 virtual DOM 这个虚拟的 JS 数据结构中，通过 bridge 传递到 native ， 然后根据数据属性设置各个对应的真实 native 的 View。 bridge 是一种 JS 和 Java 代码通信的机制， 用 bridge 函数传入对方 module 和 method 即可得到异步回调的结果。</p> <p>对于 JS 开发者来说， 画 UI 只需要画到 virtual DOM 中，不需要特别关心具体的平台, 还是原来的单线程开发，还是原来 HTML 组装 UI（JSX），还是原来的样式模型（部分兼容 )。RN 的界面处理除了实现 View 增删改查的接口之外，还自定义一套样式表达 CSSLayout，这套 CSSLayout 也是跨平台实现。 RN 拥有画 UI 的跨平台能力，主要是加入 Virtual DOM 编程模型，该方法一方面可以照顾到 JS 开发者在 html DOM 的部分传承， 让 JS 开发者可以用类似 DOM 编程模型就可以开发原生 APP ， 另一方面则可以让 Virtual DOM 适配实现到各个平台，实现跨平台的能力，并且为未来增加更多的想象空间， 比如 react-canvas, react-openGL, 而实际上 react-native 也是从 react-js 演变而来。</p> <p>对于 Android 开发者来说， RN 是一个普通的安卓程序加上一堆事件响应， 事件来源主要是 JS 的命令。主要有二个线程，UI main thread, JS thread。 UI thread 创建一个 APP 的事件循环后，就挂在 looper 等待事件 , 事件驱动各自的对象执行命令。 JS thread 运行的脚本相当于底层数据采集器， 不断上传数据，转化成 UI 事件， 通过 bridge 转发到 UI thread, 从而改变真实的 View。 后面再深一层发现， UI main thread 跟 JS thread 更像是 CS 模型，JS thread 更像服务端， UI main thread 是客户端， UI main thread 不断询问 JS thread 并且请求数据，如果数据有变，则更新 UI 界面。</p> <h2 id="参考">参考</h2> <ul><li><a href="https://neyoufan.github.io/2016/12/23/android/Android%20Js%E5%BC%95%E6%93%8E/%E5%9C%A8Android%E4%B8%8A%E4%BD%BF%E7%94%A8JS%E5%BC%95%E6%93%8E%E6%98%AF%E4%B8%80%E7%A7%8D%E4%BB%80%E4%B9%88%E6%A0%B7%E7%9A%84%E4%BD%93%E9%AA%8C%EF%BC%9F/" target="_blank" rel="noopener noreferrer">在 Android 上使用 JS 引擎是一种什么样的体验？<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://medium.com/tech-quizlet/comparison-shopping-searching-for-javascript-engines-for-android-bdc656538f2e" target="_blank" rel="noopener noreferrer">Comparison Shopping: Searching for Javascript Engines for Android<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/LiuHongtao/JustDraw" target="_blank" rel="noopener noreferrer">Canvas 绘制 JustDraw<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <div data-v-58ccb297><p class="descript" data-v-58ccb297>写文章不容易，也许写这些代码就几分钟的事，写一篇大家好接受的文章或许需要几天的酝酿，然后加上几天的码字，累并快乐着。如果文章对您有帮助请我喝杯咖啡吧！</p> <img src="/supportme.png" class="pay-code" data-v-58ccb297> <div data-v-58ccb297><div id="container"></div></div> <div class="footer" data-v-5562bdd2 data-v-58ccb297><p data-v-5562bdd2>站点总访问量： 站点总访客数：</p> <p data-v-5562bdd2>博客内容遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" data-v-5562bdd2>知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></p> <p data-v-5562bdd2>赵梦欢 © 2015 - 2019</p></div></div></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.d8a5c125.js" defer></script><script src="/assets/js/49.f9d0ccf7.js" defer></script><script src="/assets/js/16.91ab4518.js" defer></script><script src="/assets/js/31.d973ec6a.js" defer></script>
  </body>
</html>
